<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MoneyMate – Settings</title>

  <link rel="icon" href="images/favicon-32x32.png" type="image/png"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="css/styles.css"/>
</head>
<body>
<nav class="navbar navbar-dark navbar-expand-lg bg-dark">
  <div class="container-xxl">
    <a class="navbar-brand fw-bold" href="index.html">Money<span>Mate</span></a>
    <div class="ms-auto">
      <a class="btn btn-outline-light" href="dashboard.html">Back to Dashboard</a>
    </div>
  </div>
</nav>

<main class="container-xxl py-4" style="max-width:900px">
  <div class="row g-4">
    <div class="col-lg-6">
      <div class="glass p-3">
        <h5>General</h5>
        <form id="settingsForm">
          <div class="mb-2">
            <label class="form-label">Currency symbol</label>
            <input class="form-control" name="currency_symbol" placeholder="$"/>
          </div>
          <div class="mb-2">
            <label class="form-label">Budget warn threshold</label>
            <input class="form-control" name="warn_threshold" type="number" min="0" max="1" step="0.05" placeholder="0.8"/>
          </div>
          <div class="mb-2">
            <label class="form-label">Budget critical threshold</label>
            <input class="form-control" name="critical_threshold" type="number" min="0" max="2" step="0.05" placeholder="1.0"/>
          </div>
          <button class="btn btn-mm mt-2" type="submit">Save settings</button>
        </form>
        <div id="smsg" class="small mt-2"></div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="glass p-3">
        <h5>Change password</h5>
        <form id="pwForm">
          <div class="mb-2"><label class="form-label">Current password</label><input class="form-control" name="current_password" type="password" required/></div>
          <div class="mb-2"><label class="form-label">New password</label><input class="form-control" name="new_password" type="password" minlength="6" required/></div>
          <button class="btn btn-mm mt-2" type="submit">Update password</button>
        </form>
        <div id="pmsg" class="small mt-2"></div>
      </div>

      <div class="glass p-3 mt-4">
        <h5>Email notifications</h5>
        <p class="muted">Send yourself a test alert email (budget & goals).</p>
        <button id="testEmail" class="btn btn-outline-light">Send test</button>
        <div id="emsg" class="small mt-2"></div>
      </div>
    </div>
  </div>
</main>

<script type="module">
  import { api } from "./js/api.js";
  const $=s=>document.querySelector(s);

  // Load + save general settings
  async function loadSettings(){
    try{
      const r = await api("/settings","GET");
      const s = r.settings || {};
      for (const k of ["currency_symbol","warn_threshold","critical_threshold"]){
        if (s[k] !== undefined) document.querySelector(`[name='${k}']`).value = s[k];
      }
    }catch{}
  }
  $("#settingsForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const payload = Object.fromEntries(new FormData(e.target).entries());
    payload.warn_threshold = Number(payload.warn_threshold||0.8);
    payload.critical_threshold = Number(payload.critical_threshold||1.0);
    try{
      await api("/settings","POST", payload);
      $("#smsg").textContent="Saved.";
      sessionStorage.removeItem("mm_settings"); // bust cache
    }catch(err){ $("#smsg").textContent = err.message || "Save failed"; }
  });

  // Change password
  $("#pwForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const payload = Object.fromEntries(new FormData(e.target).entries());
    try{
      await api("/auth/change-password","POST", payload);
      $("#pmsg").textContent="Password updated.";
      e.target.reset();
    }catch(err){ $("#pmsg").textContent = err.message || "Update failed"; }
  });

  // Test email
  $("#testEmail").addEventListener("click", async ()=>{
    $("#emsg").textContent = "Sending…";
    try{
      const r = await api("/notifications/send","POST");
      $("#emsg").textContent = r.sent ? "Email sent." : (r.message || "No alerts to send.");
    }catch(err){ $("#emsg").textContent = err.message || "Send failed"; }
  });

  loadSettings();
</script>
</body>
</html>
